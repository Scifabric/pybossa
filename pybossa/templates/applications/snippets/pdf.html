<style type="text/css">
    #the-canvas {
        cursor: move;
    }
</style>

<div class="row">
    <!-- Success and Error Messages for the user --> 
    <!-- Question, task id, photo and action buttons for answering the question-->
    <div class="span6 offset2" style="height:50px">
        <div id="success" class="alert alert-success" style="display:none;">
            <a class="close">×</a>
            <strong>Well done!</strong> Your answer has been saved</strong>
    </div>
    <div id="taskcompleted" class="alert alert-info" style="display:none;">
        <strong>The task has been completed!</strong> Thanks a lot!</strong>
</div>

<div id="finish" class="alert alert-success" style="display:none;">
    <strong>Congratulations!</strong> You have participated in all available tasks!</strong>
<br/>
<div class="alert-actions">
    <a class="btn small" href="/">Go back</a>
    <a class="btn small" href="/app">or, Check other applications</a>
</div>
    </div>
    <div id="error" class="alert alert-error" style="display:none;">
<a class="close">×</a>
<strong>Error!</strong> Something went wrong, please contact the site administrators</strong>
    </div>
  </div> <!-- End Success and Error Messages for the user -->
</div>

<div class="row skeleton">
    <div id="question" class="span12">
      <h1>Question</h1>
      <span class="label label-info"><i class="icon icon-bullhorn"></i> Important</span> <strong>This is just a demo application. You can re-use the code to create your own application.</strong>
      <hr>
    </div>
</div>

<div class="row skeleton" style="">
      <!-- Answer buttons -->
      <div id="answer" class="span8" style="text-align:center;">
          <div class="btn-group" style="padding-bottom:5px;">
          <button class="btn" onclick="zoom(0)"><i class="icon icon-white icon-undo"></i></button>
          <button class="btn" onclick="zoom(1)"><i class="icon icon-white icon-zoom-in"></i></button>
          <button class="btn" onclick="zoom(-1)"><i class="icon icon-white icon-zoom-out"></i></button>
          </div>
          <div id="viewport" style="width:620px;height:755px;overflow:auto;">
            <canvas id="the-canvas" style="border:1px solid black;"></canvas>
          </div>
     </div>
  <div id="question" class="span4">
      <p>You are working now on task: <span id="task-id" class="label label-warning">#</span></p>
      <p>You have completed: <span id="done" class="label label-info"></span> tasks from
      <span id="total" class="label label-inverse"></span></p>
      <div class="progress progress-striped">
          <div id="progress" rel="tooltip" title="#" class="bar" style="width: 0%;"></div>
      </div>
      <div>
          <h5>Write here the transcription</h5>
          <form class="form-inline">
              <textarea id="text" rows="10" style="width:100%;"></textarea>
          </form>
          <button class="btn" onclick="submitTask()">Submit transcription!</button>
      </div>
  </div>


</div>
<script src="http://code.jquery.com/ui/1.9.1/jquery-ui.js"></script>
<script src="http://hitconsultants.com/dragscroll_scrollsync/scrollsync.js"></script>
<script src="http://hitconsultants.com/dragscroll_scrollsync/dragscrollable.js"></script>
<script src="/static/js/pybossa/pybossa.js" type="text/javascript"></script>
<!-- Use latest PDF.js build from Github -->
<script type="text/javascript" src="https://raw.github.com/mozilla/pdf.js/gh-pages/build/pdf.js"></script>

<script>
//
// Disable workers to avoid yet another cross-origin issue (workers need the URL of
// the script to be loaded, and currently do not allow cross-origin scripts)
//
$('#viewport').dragscrollable({dragSelector:'#the-canvas' });
PDFJS.disableWorker = true;

var pdfDoc = null,
    pageNum = 1,
    scale = 0.9,
    canvas = document.getElementById('the-canvas'),
    ctx = canvas.getContext('2d');

//
// Get page info from document, resize canvas accordingly, and render page
//
function renderPage(num) {
  // Using promise to fetch the page
  pdfDoc.getPage(num).then(function(page) {
    var viewport = page.getViewport(scale);
    canvas.height = viewport.height;
    canvas.width = viewport.width;

    // Render PDF page into canvas context
    var renderContext = {
      canvasContext: ctx,
      viewport: viewport
    };
    page.render(renderContext);
  });

  // Update page counters
  //document.getElementById('page_num').textContent = pageNum;
  //document.getElementById('page_count').textContent = pdfDoc.numPages;
}

function zoom(v) {

    pdfDoc.getPage(pageNum).then(function(page){
        if (v==1) {
            scale = scale + 0.1;
            if (scale >= 2) {
                scale = 2;
            }
        }
        if (v==-1) {
            scale = scale - 0.1;
            if (scale <= 0) {
                scale = 0.1;
            }
        }
        if (v==0) {
            scale = 0.8;
        }
        var viewport = page.getViewport(scale + 0.1);
        canvas.height = viewport.height;
        canvas.width = viewport.width;


        // Render PDF page into canvas context
        var renderContext = {
          canvasContext: ctx,
          viewport: viewport
        };
        page.render(renderContext);
        //$("#the-canvas").draggable({containment:'#dragContainer', cursor: 'move', scroll: false});
    });

}

//
// Go to previous page
//
function goPrevious() {
  if (pageNum <= 1)
    return;
  pageNum--;
  renderPage(pageNum);
}

//
// Go to next page
//
function goNext() {
  if (pageNum >= pdfDoc.numPages)
    return;
  pageNum++;
  renderPage(pageNum);
}



// Function to load the TaskRun data into the HTML skeleton
function loadData( data ) {
    // Uncomment next line for debugging purposes
    //console.log( data );
    if ( !$.isEmptyObject(data.task) ) {
        $("#question h1").text(data.question);
        $("#task-id").text(data.task.id);
        $("#photo-link").attr("href", data.task.info.link);
        $("#photo").attr("src",data.task.info.url_m);
    }
    else {
        $(".skeleton").hide();
        $("#finish").fadeIn();
    }
}

function loadTask( task_id ) {
    // Uncomment next line for debugging purposes
    //console.log( data );
    var t = $.ajax({
        url: '/api/task/'+task_id,
        dataType: 'json'
    });
    t.done( function (task) {
        if ( !$.isEmptyObject(task) ) {
            if (task.state=='completed') {
                $('#answer').hide();
                $('#taskcompleted').show();
            }
            loadUserProgress();
            $("#question h1").text(task.info.question);
            $("#task-id").text(task.id);
            pageNum = task.info.page;
            //
            // NOTE: 
            // Modifying the URL below to another server will likely *NOT* work. Because of browser
            // security restrictions, we have to use a file server with special headers
            // (CORS) - most servers don't support cross-origin browser requests.
            var url = task.info.pdf_url;
            //
            // Asynchronously download PDF as an ArrayBuffer
            //
            PDFJS.getDocument(url).then(function getPdfHelloWorld(_pdfDoc) {
              pdfDoc = _pdfDoc;
              renderPage(pageNum);
            });
        }
        else {
            $(".skeleton").hide();
            $("#finish").fadeIn();
        }
    });
}

function loadUserProgress() {
    pybossa.userProgress('pdftranscribe').done(function(data){
        var pct = Math.round((data.done*100)/data.total);
        $("#progress").css("width", pct.toString() +"%");
        $("#progress").attr("title", pct.toString() + "% completed!");
        $("#progress").tooltip({'placement': 'left'}); 
        $("#total").text(data.total);
        $("#done").text(data.done);
    });
}

// Function to submit and save the TaskRun in PyBossa
function submitTask() {
    // Get the task-id
    var taskid = $("#task-id").text();
    var answer = $("textarea#text").val();
    console.log(answer);
    // Save the task
    pybossa.saveTask(taskid, answer).done( function( data ) {
        // Uncoment next line for debugging purposes
        //console.log("Answer saved!");
        // FadeIn & Out the success div feedback
        $("#success").fadeIn();
        setTimeout(function() { $("#success").fadeOut() }, 2000);
        // Load a new task
        //pybossa.newTask("flickrperson").done( function( data ){ loadData( data ) });
        window.location.pathname = "/app/pdftranscribe/newtask";
    });
}

// Check if the user is loading directly a task or requesting a new one
var taskId = pybossa.getCurrentTaskId(window.location.pathname);

if (taskId){
    // The user is loading directly a task, so load then input data
    loadTask(taskId);
}
else {
    // The user is requesting a new task, so get a new one
    pybossa.newTask("pdftranscribe").done( function( data ) { 

        if ( !$.isEmptyObject(data.task) ) {
            window.location.pathname = "/app/pdftranscribe/task/" + data.task.id;
        }
        else {
            $(".skeleton").hide();
            $("#finish").fadeIn();
        }
    });
}
</script>
