window.CVM={version:"1.0"};(function(P){var R={init:function(){this.browser=this.searchString(this.dataBrowser)||"An unknown browser";this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"an unknown version";this.OS=this.searchString(this.dataOS)||"an unknown OS"},searchString:function(aa){for(var X=0;X<aa.length;X++){var Y=aa[X].string;var Z=aa[X].prop;this.versionSearchString=aa[X].versionSearch||aa[X].identity;if(Y){if(Y.indexOf(aa[X].subString)!=-1){return aa[X].identity}}else{if(Z){return aa[X].identity}}}},searchVersion:function(Y){var X=Y.indexOf(this.versionSearchString);if(X==-1){return}return parseFloat(Y.substring(X+this.versionSearchString.length+1))},dataBrowser:[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{prop:window.opera,identity:"Opera",versionSearch:"Version"},{string:navigator.vendor,subString:"iCab",identity:"iCab"},{string:navigator.vendor,subString:"KDE",identity:"Konqueror"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"}],dataOS:[{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.userAgent,subString:"iPhone",identity:"iPhone/iPod"},{string:navigator.platform,subString:"Linux",identity:"Linux"}]};R.init();var H=null,A=false,B=[];var g=function(X,Y){Y(window.confirm(X))};P.setConfirmFunction=function(Y){var X=false;g=function(Z,aa){X=true;Y(Z,function(ab){if(X){X=false;aa(ab)}})}};P.debugLogging=false;P.autoUpdate=true;var T=function(X){alert(X)};P.setAlertFunction=function(X){T=X};var C=function(Y,X){};P.setGlobalErrorHandler=function(X){C=X};function e(X,Z,Y){if(X){if(X(Z,Y)){return}}C(Z,Y)}P.startCVMWebAPI=function(aa,Z,Y){if(Z===true){Y=true;Z=null}var X=function(){if(H==null){H=document.getElementById("cvmweb-api");if(!H){H=document.createElement("embed");if(H==null){e(Z,"Your browser does not support the <embed /> tag!",-101);return}H.type="application/x-cvmweb";H.id="cvmweb-api";H.style.width="1px";H.style.height="1px";document.body.appendChild(H)}console.log("Using CernVM WebAPI "+H.version)}var ab=function(){H.requestDaemonAccess(function(ac){aa(new P.WebAPIPlugin(H,ac))},function(ac){e(Z,"Unable to obtain daemon access: "+y(ac),ac)})};if(H.version==undefined){if(Y){g("This website is using the CernVM Web API extension, but it doesn't seem to be installed in your browser.\n\nDo you want to install it now?",function(ac){if(ac){if(R.browser=="Firefox"){window.location="http://labs.wavesoft.gr/micro/res/cvmwebapi-1.2.1.xpi"}else{if(R.browser=="Chrome"){window.location="https://chrome.google.com/webstore/detail/cernvm-web-api/iakpghcolokcngbhjiihjcomioihjnfm"}else{window.location="http://cernvm.cern.ch/portal/webapi"}}}else{e(Z,"Unable to load CernVM WebAPI Plugin. Make sure it's installed!",-100)}})}else{e(Z,"Unable to load CernVM WebAPI Plugin. Make sure it's installed!",-100)}}else{if(Y){if(H.hypervisorName==""){g("You are going to need a hypervisor before you can use this website. Do you allow the CernVM Web API extension to install Oracle VirtualBox for you?",function(af){if(af){var ad=true;var ac=function(){if(ad){ad=false}else{return}H.removeEventListener("install",ac);ab()};var ae=function(ag){if(ad){ad=false}else{return}H.removeEventListener("installError",ae);e(Z,"Unable to install hypervisor!",-103)};H.addEventListener("install",ac);H.addEventListener("installError",ae);H.installHypervisor()}else{e(Z,"User denied hypervisor installation!",-102)}})}else{ab()}}else{ab()}}};if(!A){B.push(X)}else{X()}};var j=0;var K=1;var V=2;var m=1;var p=0;var b=-1;var l=-2;var S=-3;var d=-4;var a=-5;var G=-6;var o=-7;var t=-8;var v=-9;var F=-10;var h=-11;var i=-12;var q=-13;var I=-99;var k=-100;var D=0;var c=1;var J=2;var u=3;var w=4;var L=5;var O=6;var Q=1;var s=2;var U=4;var n=8;var M=16;var r=1;var N=2;function z(X){if(X==D){return"Closed"}if(X==c){return"Oppening"}if(X==J){return"Open"}if(X==u){return"Starting"}if(X==w){return"Started"}if(X==L){return"Error"}if(X==O){return"Paused"}return"Unknown state "+X}function y(X){if(X==V){return"Already exists"}if(X==m){return"Scheduled"}if(X==p){return"No error"}if(X==b){return"Creation Error"}if(X==l){return"Modification Error"}if(X==S){return"Control Error"}if(X==d){return"Deletion Error"}if(X==a){return"Query Error"}if(X==G){return"I/O Error"}if(X==o){return"Server/Library Error"}if(X==t){return"Invalid state for such action"}if(X==v){return"The requested resource was not found"}if(X==F){return"Access denied"}if(X==h){return"The requested action is not supported"}if(X==i){return"Unable to validate the resource"}if(X==q){return"The domain is not trusted"}if(X==I){return"Usage error"}if(X==k){return"The requested functionality is not implemented"}return"Unknown error #"+X}P.EventDispatcher=function(X){this.events={}};P.EventDispatcher.prototype.__fire=function(Y){var X=Array.prototype.slice.call(arguments),Y=X.shift();window.console.log("Firing",Y,"(",X,")");if(this.events[Y]==undefined){return}var aa=this.events[Y];for(var Z=0;Z<aa.length;Z++){aa[Z].apply(this,X)}};P.EventDispatcher.prototype.addEventListener=function(X,Y){if(this.events[X]==undefined){this.events[X]=[]}this.events[X].push(Y)};P.EventDispatcher.prototype.removeEventListener=function(X,Z){if(this.events[X]==undefined){return}var Y=this.events[X].indexOf(Z);if(Y<0){return}this.events.splice(Y,1)};var Q=1;var s=2;var U=4;var n=8;var W=function(Y){var X=0;if(Y.use64bit){X|=Q}if(Y.useBootDisk){X|=s}if(Y.useGuestAdditions){X|=U}if(Y.useFloppyIO){X|=n}if(Y.HVF_HEADFUL){X|=M}return X};var f=function(Z){var X=function(aa){Z.flags=aa},Y=function(){return Z.flags};Object.defineProperties(this,{value:{get:function(){return Y()},set:function(aa){X(aa)}},use64bit:{get:function(){return((Y()&Q)!=0)},set:function(aa){if(aa){X(Y()|Q)}else{X(Y()&~Q)}}},useBootDisk:{get:function(){return((Y()&s)!=0)},set:function(aa){if(aa){X(Y()|s)}else{X(Y()&~s)}}},useGuestAdditions:{get:function(){return((Y()&U)!=0)},set:function(aa){if(aa){X(Y()|U)}else{X(Y()&~U)}}},useFloppyIO:{get:function(){return((Y()&n)!=0)},set:function(aa){if(aa){X(Y()|n)}else{X(Y()&~n)}}},headful:{get:function(){return((Y()&M)!=0)},set:function(aa){if(aa){X(Y()|M)}else{X(Y()&~M)}}}})};var E=function(Y){var X=0;if(Y.suspend){X|=r}if(Y.autoStart){X|=N}return X};var x=function(Z){var X=function(aa){Z.daemonFlags=aa},Y=function(){return Z.daemonFlags};Object.defineProperties(this,{value:{get:function(){return Y()},set:function(aa){X(aa)}},suspend:{get:function(){return((Y()&r)!=0)},set:function(aa){if(aa){X(Y()|r)}else{X(Y()&~r)}}},autoStart:{get:function(){return((Y()&N)!=0)},set:function(aa){if(aa){X(Y()|N)}else{X(Y()&~N)}}}})};P.WebAPIPlugin=function(X,Y){P.EventDispatcher.call(this);this.__plugin=X;this.__daemon=Y;Object.defineProperties(this,{domain:{get:function(){return this.__plugin.domain}}})};P.WebAPIPlugin.prototype=Object.create(P.EventDispatcher.prototype);P.WebAPIPlugin.prototype.hasHypervisor=function(){if(!this.__plugin){return false}return(this.__plugin.version!=undefined)&&(this.__plugin.hypervisorName!="")},P.WebAPIPlugin.prototype.requestSession=function(X,Z,Y){if(!X){return false}if(!Z){return false}if(typeof(X)!="string"){return false}if(typeof(Z)!="function"){return false}if((Y)&&(typeof(Y)!="function")){return false}this.__plugin.requestSafeSession(X,(function(ad){cSession=ad;if((ad.state==D)||(ad.state==L)){var ac=true;var ab=(function(){if(ac){ac=false}else{return}ad.removeEventListener("open",ab);Z(new P.WebAPISession(this.__plugin,this.__daemon,ad))}).bind(this);var aa=(function(ae){if(ac){ac=false}else{return}ad.removeEventListener("error",aa);e(Y,"Could not open session: "+y(ae)+".",ae)}).bind(this);ad.addEventListener("open",ab);ad.addEventListener("openError",aa);ad.open()}else{Z(new P.WebAPISession(this.__plugin,this.__daemon,ad))}}).bind(this),function(aa){console.error("RequestSession Error #"+aa);e(Y,"Could not request session: "+y(aa)+".",aa)})};P.WebAPISession=function(Z,ab,ad){P.EventDispatcher.call(this);this.__plugin=Z;this.__daemon=ab;this.__session=ad;this.__valid=true;this.__daemonStatus=false;this.__systemStatus=false;this.autoUpdate=P.autoUpdate;if(P.debugLogging){this.__session.addEventListener("debug",function(ae){console.log("[Debug] "+ae)})}this.__checkDaemonUpdates=function(){var ae=this.__daemon.isRunning;if(ae!=this.__daemonStatus){this.__daemonStatus=ae;this.__fire("daemonStateChange",ae)}if(ae){var af=this.__daemon.isSystemIdle;if(af!=this.__systemStatus){this.__systemStatus=af;this.__fire("systemStateChange",af)}}};var X=setInterval((function(){if(this.autoUpdate){this.__session.update()}this.__checkDaemonUpdates()}).bind(this),5000);var Y=undefined;Object.defineProperties(this,{state:{get:function(){if(!this.__valid){return Y}return this.__session.state}},stateName:{get:function(){if(!this.__valid){return Y}return z(this.__session.state)}},ip:{get:function(){if(!this.__valid){return Y}return this.__session.ip}},ram:{get:function(){if(!this.__valid){return Y}return this.__session.ram}},disk:{get:function(){if(!this.__valid){return Y}return this.__session.disk}},apiURL:{get:function(){if(!this.__valid){return Y}return this.__session.apiURL}},rdpURL:{get:function(){if(!this.__valid){return Y}return this.__session.rdpURL}},executionCap:{get:function(){if(!this.__valid){return Y}return this.__session.executionCap},set:function(ae){this.__session.setExecutionCap(ae)}},daemonMinCap:{get:function(){if(!this.__valid){return Y}return this.__session.daemonMinCap},set:function(ae){this.__session.daemonMinCap=ae}},daemonMaxCap:{get:function(){if(!this.__valid){return Y}return this.__session.daemonMaxCap},set:function(ae){this.__session.daemonMaxCap=ae}},daemonControlled:{get:function(){if(!this.__valid){return Y}return this.__session.daemonControlled},set:function(ae){this.__session.daemonControlled=ae;setTimeout((function(){this.__checkDaemonUpdates()}).bind(this),500)}},version:{get:function(){if(!this.__valid){return Y}return((this.__session.flags&s)==0)?this.__session.version:""}},diskURL:{get:function(){if(!this.__valid){return Y}return((this.__session.flags&s)!=0)?this.__session.version:""}},flags:{get:function(){if(!this.__valid){return Y}return new f(this.__session)},set:function(ae){if(typeof(ae)=="number"){this.__session.flags=ae}else{if(typeof(ae)=="object"){this.__session.flags=W(ae)}}}},daemonFlags:{get:function(){if(!this.__valid){return Y}return new x(this.__session)},set:function(ae){if(typeof(ae)=="number"){this.__session.daemonFlags=ae}else{if(typeof(ae)=="object"){this.__session.daemonFlags=E(ae)}}}}});var ac=(function(){clearInterval(X);this.__valid=false}).bind(this);this.__session.addEventListener("open",(function(){this.__fire("sessionStateChange",J);this.__fire("open")}).bind(this));this.__session.addEventListener("close",(function(){this.__fire("sessionStateChange",D);this.__fire("close");ac()}).bind(this));this.__session.addEventListener("start",(function(){this.__fire("sessionStateChange",w);this.__fire("start")}).bind(this));this.__session.addEventListener("stop",(function(){this.__fire("sessionStateChange",J);this.__fire("stop")}).bind(this));this.__session.addEventListener("pause",(function(){this.__fire("sessionStateChange",O);this.__fire("pause")}).bind(this));this.__session.addEventListener("resume",(function(){this.__fire("sessionStateChange",w);this.__fire("resume")}).bind(this));this.__session.addEventListener("hibernate",(function(){this.__fire("sessionStateChange",J);this.__fire("hibernate")}).bind(this));this.__session.addEventListener("error",(function(af,ae,ag){this.__fire("error",af,ae,ag)}).bind(this));this.__session.addEventListener("reset",(function(af,ae,ag){this.__fire("reset")}).bind(this));this.__session.addEventListener("openError",(function(af,ae){this.__fire("openError",af,ae)}).bind(this));this.__session.addEventListener("closeError",(function(af,ae){this.__fire("closeError",af,ae)}).bind(this));this.__session.addEventListener("startError",(function(af,ae){this.__fire("startError",af,ae)}).bind(this));this.__session.addEventListener("stopError",(function(af,ae){this.__fire("stopError",af,ae)}).bind(this));this.__session.addEventListener("pauseError",(function(af,ae){this.__fire("pauseError",af,ae)}).bind(this));this.__session.addEventListener("resetError",(function(af,ae){this.__fire("resetError",af,ae)}).bind(this));this.__session.addEventListener("hibernateError",(function(af,ae){this.__fire("hibernateError",af,ae)}).bind(this));this.__session.addEventListener("apiAvailable",(function(af,ae){this.__fire("apiAvailable",af,ae)}).bind(this));this.__session.addEventListener("apiUnavailable",(function(){this.__fire("apiUnavailable")}).bind(this));var aa=false;this.__session.addEventListener("progress",(function(af,ae,ag){if(!aa){this.__fire("progressBegin");aa=true}this.__fire("progress",Math.round(100*af/ae),ag);if(af==ae){this.__fire("progressEnd");aa=false}}).bind(this));setTimeout((function(){this.__fire("daemonStateChange",this.__daemonStatus);this.__fire("systemStateChange",this.__systemStatus);if(this.__session.state!=D){this.__fire("sessionStateChange",this.__session.state)}}).bind(this),1)};P.WebAPISession.prototype=Object.create(P.EventDispatcher.prototype);P.WebAPISession.prototype.start=function(aa,ae,ad){if(!this.__valid){return false}if(typeof(aa)=="function"){ad=ae;ae=aa;aa=false}if(!aa){aa={}}var Y=true,Z=function(){if(Y){Y=false}else{return}if(ae){ae()}X()},ac=function(ag,af){if(Y){Y=false}else{return}e(ad,"Could not start: "+ag,af);X()},X=(function(){this.__session.removeEventListener("start",Z);this.__session.removeEventListener("startError",ac)}).bind(this);this.__session.addEventListener("start",Z);this.__session.addEventListener("startError",ac);var ab=this.__session.start(aa);if(ab!=m){e(ad,"Could not start: "+y(ab),ab);return false}this.__checkDaemonUpdates();return true};P.WebAPISession.prototype.stop=function(ad,ac){if(!this.__valid){return false}var Y=true,Z=function(){if(Y){Y=false}else{return}if(ad){ad()}X()},ab=function(af,ae){if(Y){Y=false}else{return}e(ac,"Could not stop: "+af,ae);X()},X=(function(){this.__session.removeEventListener("stop",Z);this.__session.removeEventListener("stopError",ab)}).bind(this);this.__session.addEventListener("stop",Z);this.__session.addEventListener("stopError",ab);var aa=this.__session.stop();if(aa!=m){e(ac,"Could not stop: "+y(aa),aa);return false}this.__checkDaemonUpdates();return true};P.WebAPISession.prototype.pause=function(ad,ac){if(!this.__valid){return false}var Y=true,Z=function(){if(Y){Y=false}else{return}if(ad){ad()}X()},ab=function(af,ae){if(Y){Y=false}else{return}e(ac,"Could not pause: "+af,ae);X()},X=(function(){this.__session.removeEventListener("pause",Z);this.__session.removeEventListener("pauseError",ab)}).bind(this);this.__session.addEventListener("pause",Z);this.__session.addEventListener("pauseError",ab);var aa=this.__session.pause();if(aa!=m){e(ac,"Could not pause: "+y(aa),aa);return false}this.__checkDaemonUpdates();return true};P.WebAPISession.prototype.resume=function(ad,ac){if(!this.__valid){return false}var Y=true,Z=function(){if(Y){Y=false}else{return}if(ad){ad()}X()},ab=function(af,ae){if(Y){Y=false}else{return}e(ac,"Could not resume: "+af,ae);X()},X=(function(){this.__session.removeEventListener("resume",Z);this.__session.removeEventListener("resumeError",ab)}).bind(this);this.__session.addEventListener("resume",Z);this.__session.addEventListener("resumeError",ab);var aa=this.__session.resume();if(aa!=m){e(ac,"Could not resume: "+y(aa),aa);return false}this.__checkDaemonUpdates();return true};P.WebAPISession.prototype.hibernate=function(ad,ac){if(!this.__valid){return false}var Y=true,Z=function(){if(Y){Y=false}else{return}if(ad){ad()}X()},ab=function(af,ae){if(Y){Y=false}else{return}e(ac,"Could not hibernate: "+af,ae);X()},X=(function(){this.__session.removeEventListener("hibernate",Z);this.__session.removeEventListener("hibernateError",ab)}).bind(this);this.__session.addEventListener("hibernate",Z);this.__session.addEventListener("hibernateError",ab);var aa=this.__session.hibernate();if(aa!=m){e(ac,"Could not hibernate: "+y(aa),aa);return false}this.__checkDaemonUpdates();return true};P.WebAPISession.prototype.reset=function(ad,ac){if(!this.__valid){return false}var Y=true,Z=function(){if(Y){Y=false}else{return}if(ad){ad()}X()},ab=function(af,ae){if(Y){Y=false}else{return}e(ac,"Could not reset: "+af,ae);X()},X=(function(){this.__session.removeEventListener("reset",Z);this.__session.removeEventListener("resetError",ab)}).bind(this);this.__session.addEventListener("reset",Z);this.__session.addEventListener("resetError",ab);var aa=this.__session.reset();if(aa!=m){e(ac,"Could not reset: "+y(aa),aa);return false}this.__checkDaemonUpdates();return true};P.WebAPISession.prototype.close=function(aa){if(!this.__valid){return false}var Y=true,Z=function(){if(Y){Y=false}else{return}if(aa){aa()}X()},X=(function(){this.__session.removeEventListener("close",Z)}).bind(this);this.__session.addEventListener("close",Z);this.__session.close();this.__valid=false;this.__checkDaemonUpdates();return true};window.addEventListener("load",function(Y){A=true;for(var X=0;X<B.length;X++){B[X]()}})})(window.CVM);
